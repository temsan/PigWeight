# TODO проекта PigWeight

Короткий, приоритизированный план. Статус: расследование старта инференса и стабильности RTSP + доведение ключевых фич.

## Now (критично)

- [ ] Старт сервера и сбор диагностик старта
  - Записать логи стадий: RTSP open, preload модели, запуск `_infer_loop` (`logs/perf.log`, `api/app.py`).
  - Проверить RTSP вне приложения (VLC/ffmpeg) и таймауты FFmpeg/OpenCV.
  - Использовать debug-эндпоинты: `/debug/preload_model`, `/debug/infer_status` (при наличии).
  - По итогам логов: добавить таймауты/ретраи/квоты задач, чтобы исключить зависания.
- [ ] Верификация серверных эндпоинтов счёта/веса
  - `GET /api/count_series` возвращает точки за окно и статус камеры.
  - `POST /api/weight/average` пишет CSV `records/weight_avg_YYYYMMDD.csv` и чистит по ретенции.
- [ ] RTSP стабильность
  - Сравнить `AUTO_START_CAM`, `PRELOAD_MODEL` (см. lifespan в `api/app.py`).
  - Проверить параметры `FPS`, `FRAME_SKIP`, `CONF_THRESHOLD`, нагрузку CPU/GPU.

### Definition of Done (Now)
- Логи старта без исключений, инференс идёт стабильно ≥10 минут.
- `count_series` и `weight/average` дают корректные ответы, CSV создаётся.

## Next (в работе дальше)

- [ ] Фронтенд: плеер и взаимодействие
  - HTML5-плеер с контролами (`static/index.html`, `static/js/video-player.js`).
  - Scrubbing по таймлайну + мгновенный seek.
  - WS-обновления счётчика синхронно с воспроизведением.
- [ ] Индексация/кэш
  - Фоновая индексация кадров (миниатюры/превью) — класс `VideoIndexer`.
  - Кэш статистики по ключевым таймстемпам; быстрые ответы UI.
  - Хранение индекса (файлы/Redis) и загрузка при старте.

### Definition of Done (Next)
- Плеер поддерживает паузу/перемотку, обновляет счётчик в UI в реальном времени.
- Индекс позволяет быстрый ответ по кадру/интервалу (<100 мс на запрос).

## Later (среднесрочно)

- [ ] HLS-поток для файлов
  - Генерация m3u8 + сегментов (TS/FMP4), Range, кэш-заголовки.
  - Эндпоинт в `api/app.py`: `GET /api/video_file/stream_hls/{video_id}`.
- [ ] GPU и производительность инференса
  - Пакетный инференс на GPU (batch 2–4), раздача результатов по запросам.
  - Разнести декодирование/инференс по потокам/executor, не блокируя event loop.
- [ ] Live-камеры WebRTC
  - Трек через aiortc и сигнальные эндпоинты в `api/app.py`.
  - Минимизация задержки, fallback при недоступности камеры.
- [ ] Тестирование и прод-готовность
  - Нагрузочные тесты на видео 10GB+, профилирование CPU/GPU.
  - Кросс-браузерные тесты (Chrome/Firefox/Safari/Edge; desktop/mobile).
  - Кэш-хедеры, сжатие, лимиты памяти и воркеров.
  - Документация и user-guide по плееру и API.

## Риски и примечания

- RTSP-нестабильность: камеры, сеть, FFmpeg таймауты — смягчать ретраями и backoff.
- Ограничения железа: GPU/CPU — отслеживать загрузку и править `FRAME_SKIP`, `TARGET_FPS`.
- Среда: переменные `PRELOAD_MODEL`, `AUTO_START_CAM`, `FPS`, `FRAME_SKIP`, `CONF_THRESHOLD`.

## Справочно

- Эндпоинты для UI:
  - `GET /api/video_file/count_at_time?id=...&t=...`
  - `GET /api/video_file/stream_hls/{video_id}` (после реализации HLS)
- Источники: `OPTIMIZATION_TODO.md` (объединено сюда), `OPTIMIZATION_RECOMMENDATIONS.md`, `OPTIMIZATION_SUMMARY.md`.
