# TODO проекта PigWeight

Общий список задач: текущее расследование старта инференса + незавершённые оптимизации.

## 1) Срочно: запуск инференса и стабильность RTSP

- [ ] Запустить сервер и собрать логи старта (RTSP open, preload модели, запуск `_infer_loop`).
- [ ] Проверить RTSP доступность вне приложения (VLC/ffmpeg), сверить таймауты OpenCV/FFmpeg.
- [ ] Локализовать синхронные узкие места (инициализация модели, блокирующие вызовы) и предложить фиксы.
- [ ] Использовать debug-эндпоинты: `/debug/preload_model`, `/debug/infer_status` для диагностики.
- [ ] По итогам логов — добавить таймауты/ретраи/квоты задачам, чтобы избежать «Step is still running».

Справочно:
- Переменные окружения: `PRELOAD_MODEL`, `AUTO_START_CAM` (см. `api/app.py` — lifespan).

## 2) Фронтенд (UI видео) — незавершённое

- [ ] HTML5-плеер с кастомными контролами (`static/index.html` + `static/js/video-player.js`).
- [ ] Интерактивный scrubbing и мгновенное перемещение по таймлайну.
- [ ] WebSocket-обновления счётчика синхронно с воспроизведением.
- [ ] Адаптивная верстка (desktop/mobile).

Эндпоинты, которые потребуется подключить:
- `GET /api/video_file/count_at_time?id=...&t=...`
- `GET /api/video_file/stream_hls/{video_id}` (после реализации HLS)

## 3) HLS-поток — незавершённое

- [ ] Реализовать HLS-сегментацию для файлов (m3u8 + сегменты TS/fragmented MP4) и эндпоинт в `api/app.py`.
- [ ] Range-запросы, корректные кэш-заголовки, длительное воспроизведение.

## 4) Индексация/кэш — незавершённое

- [ ] Фоновая индексация кадров (в т.ч. миниатюры/превью) — класс наподобие `VideoIndexer`.
- [ ] Кэш статистики подсчёта по ключевым таймстемпам, быстрый ответ UI.
- [ ] Сохранение индекса (файлы/Redis) и загрузка при старте.

## 5) GPU и производительность инференса — незавершённое

- [ ] Пакетный инференс на GPU (batch 2–4 кадра), распределение результатов по запросам.
- [ ] Разнести декодирование и инференс по потокам/executor, не блокируя event loop.

## 6) Live-камеры через WebRTC — незавершённое

- [ ] Реализовать WebRTC-трек (aiortc) и сигнальные эндпоинты в `api/app.py`.
- [ ] Минимизировать задержку и предусмотреть fallback при недоступности камеры.

## 7) Тестирование и деплой — незавершённое

- [ ] Нагрузочные тесты на больших видео (10GB+), профилирование CPU/GPU.
- [ ] Кросс-браузерное тестирование (Chrome/Firefox/Safari/Edge; desktop/mobile).
- [ ] Прод-оптимизации: кэш-хедеры, сжатие, лимиты памяти и воркеров.
- [ ] Документация и user guide по новому плееру и эндпоинтам.

## 8) Быстрые эндпоинты (проверка интеграции)

- [ ] Убедиться, что UI использует `api/ultra_fast_endpoints.py` как быстрый fallback для файлов.
- [ ] Интегрировать быстрый стрим/кадры без инференса для мгновенного старта.

---
Источник незавершённых пунктов: `OPTIMIZATION_TODO.md` (объединено сюда), `OPTIMIZATION_RECOMMENDATIONS.md`, `OPTIMIZATION_SUMMARY.md`.
