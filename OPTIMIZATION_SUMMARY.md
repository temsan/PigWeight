# PigWeight System Optimization Summary

## –ü—Ä–æ–±–ª–µ–º—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ —Ä–µ—à–µ–Ω—ã

### 1. ‚ùå –ú–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω—ã–µ –∫–æ–¥–∏—Ä–æ–≤–∫–∏ –∏ –ø–µ—Ä–µ–∫–æ–¥–∏—Ä–æ–≤–∫–∏
**–ë—ã–ª–æ:**
- JPEG ‚Üí numpy ‚Üí JPEG ‚Üí BMP ‚Üí multipart
- Base64 fallbacks –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
- –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è –æ–¥–Ω–æ–≥–æ –∏ —Ç–æ–≥–æ –∂–µ –∫–∞–¥—Ä–∞

**–°—Ç–∞–ª–æ:**
- –ü—Ä—è–º–æ–π –ø—É—Ç—å: JPEG –∏–∑ OpenCV worker ‚Üí multipart stream
- JPEG –≤–º–µ—Å—Ç–æ BMP –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ —Ç—Ä–∞—Ñ–∏–∫–∞
- –£–±—Ä–∞–Ω—ã –≤—Å–µ base64 fallbacks

### 2. ‚ùå –û–≥—Ä–æ–º–Ω—ã–µ —Ç–∞–π–º–∞—É—Ç—ã OpenCV –≤–æ—Ä–∫–µ—Ä–∞
**–ë—ã–ª–æ:**
- 15 —Å–µ–∫—É–Ω–¥ –¥–ª—è RTSP –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- 10-15 —Å–µ–∫—É–Ω–¥ –¥–ª—è —Ñ–∞–π–ª–æ–≤
- 5+ —Å–µ–∫—É–Ω–¥ –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π —á—Ç–µ–Ω–∏—è

**–°—Ç–∞–ª–æ:**
- 3 —Å–µ–∫—É–Ω–¥—ã –¥–ª—è RTSP
- 2 —Å–µ–∫—É–Ω–¥—ã –¥–ª—è —Ñ–∞–π–ª–æ–≤  
- 0.3-0.5 —Å–µ–∫—É–Ω–¥—ã –¥–ª—è —á—Ç–µ–Ω–∏—è

### 3. ‚ùå –°–ª–æ–∂–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å –ª–∏—à–Ω–∏–º–∏ —Ü–∏–∫–ª–∞–º–∏ –æ–∂–∏–¥–∞–Ω–∏—è
**–ë—ã–ª–æ:**
```python
while True:
    ok, frame = cap.read()
    if ok and frame is not None:
        return frame
    if timeout > limit:
        return None
    time.sleep(0.01)  # –õ–∏—à–Ω–∏–µ –∑–∞–¥–µ—Ä–∂–∫–∏!
```

**–°—Ç–∞–ª–æ:**
```python
ok, frame = cap.read()  # –û–¥–Ω–æ —á—Ç–µ–Ω–∏–µ
if ok and frame is not None:
    return frame
return None
```

### 4. ‚ùå –ü–µ—Ä–µ—É—Å–ª–æ–∂–Ω–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤
**–ë—ã–ª–æ:**
- –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ warm-up —á—Ç–µ–Ω–∏—è
- 3 —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ seek —Å –æ—Ç–∫–∞—Ç–∞–º–∏
- –°–ª–æ–∂–Ω—ã–µ fallback –º–µ—Ö–∞–Ω–∏–∑–º—ã

**–°—Ç–∞–ª–æ:**
- –ü—Ä—è–º–æ–π seek –Ω–∞ –Ω—É–∂–Ω—ã–π –∫–∞–¥—Ä
- –û–¥–Ω–æ —á—Ç–µ–Ω–∏–µ –±–µ–∑ warm-up
- –ü—Ä–æ—Å—Ç—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –±–µ–∑ –ø–µ—Ä–µ—É—Å–ª–æ–∂–Ω–µ–Ω–∏—è

## –ö–ª—é—á–µ–≤—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### üöÄ 1. –£–ø—Ä–æ—â–µ–Ω–∏–µ –ø—É—Ç–∏ –¥–∞–Ω–Ω—ã—Ö
- **–ö–∞–º–µ—Ä–∞**: RTSP ‚Üí OpenCV Worker (JPEG) ‚Üí FastAPI ‚Üí Browser
- **–§–∞–π–ª**: –ü—Ä—è–º–æ–π MJPEG –ø–æ—Ç–æ–∫ –±–µ–∑ WebSocket –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤
- **–ú–∞—Å–∫–∏**: –ó–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –ø–æ –º–µ—Ä–µ –∏–Ω—Ñ–µ—Ä–µ–Ω—Å–∞, –Ω–µ –±–ª–æ–∫–∏—Ä—É—é—Ç –ø–æ—Ç–æ–∫

### üöÄ 2. –£–ª—å—Ç—Ä–∞-–±—ã—Å—Ç—Ä—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã
- `/api/video_file/stream_ultra_fast` - –ø–æ—Ç–æ–∫ –±–µ–∑ –∏–Ω—Ñ–µ—Ä–µ–Ω—Å–∞
- `/api/video_file/frame_ultra_fast` - –∫–∞–¥—Ä –±–µ–∑ –∏–Ω—Ñ–µ—Ä–µ–Ω—Å–∞  
- `/ws/video_ultra_fast` - WebSocket —Å fallback –∫ —Ç–µ—Å—Ç–æ–≤–æ–º—É –ø–∞—Ç—Ç–µ—Ä–Ω—É

### üöÄ 3. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π OpenCV Worker
- –£–±—Ä–∞–Ω—ã —Ü–∏–∫–ª—ã –æ–∂–∏–¥–∞–Ω–∏—è
- –°–æ–∫—Ä–∞—â–µ–Ω—ã —Ç–∞–π–º–∞—É—Ç—ã –≤ 5-10 —Ä–∞–∑
- –ü—Ä—è–º–æ–µ JPEG –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö —ç—Ç–∞–ø–æ–≤

### üöÄ 4. –£–º–Ω—ã–π —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥
- –ü—Ä—è–º–æ–µ MJPEG –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –±–µ–∑ WebSocket –¥–ª—è —Ñ–∞–π–ª–æ–≤
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∑–∞–¥–µ—Ä–∂–∫–∏ –Ω–∞ –ø–µ—Ä–µ–º–æ—Ç–∫—É

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
- –ó–∞–¥–µ—Ä–∂–∫–∞ –ø–æ—Ç–æ–∫–∞: 500-1000ms
- CPU –Ω–∞–≥—Ä—É–∑–∫–∞: –≤—ã—Å–æ–∫–∞—è (–º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω—ã–µ –∫–æ–¥–∏—Ä–æ–≤–∫–∏)
- –§—Ä–∏–∑—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–æ–≤
- –¢–∞–π–º–∞—É—Ç—ã 15+ —Å–µ–∫—É–Ω–¥

### –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
- –ó–∞–¥–µ—Ä–∂–∫–∞ –ø–æ—Ç–æ–∫–∞: 50-150ms
- CPU –Ω–∞–≥—Ä—É–∑–∫–∞: —Å–Ω–∏–∂–µ–Ω–∞ –≤ 2-3 —Ä–∞–∑–∞
- –ü–ª–∞–≤–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤
- –¢–∞–π–º–∞—É—Ç—ã 2-3 —Å–µ–∫—É–Ω–¥—ã

## –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å Live –∫–∞–º–µ—Ä–æ–π

‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –≤–Ω–µ—à–Ω–µ–π –∫–∞–º–µ—Ä–µ (–Ω–µ –≤–µ–±-–∫–∞–º–µ—Ä–µ) —á–µ—Ä–µ–∑ RTSP
‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –º–∞—Å–æ–∫ –ø–æ –º–µ—Ä–µ –∏–Ω—Ñ–µ—Ä–µ–Ω—Å–∞
‚úÖ –ü—Ä—è–º–æ–π –≤–∏–¥–µ–æ –ø–æ—Ç–æ–∫ –±–µ–∑ –ª–∏—à–Ω–∏—Ö –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–π
‚úÖ Fallback –∫ —Ç–µ—Å—Ç–æ–≤–æ–º—É –ø–∞—Ç—Ç–µ—Ä–Ω—É –µ—Å–ª–∏ –∫–∞–º–µ—Ä–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞

## –§–∞–π–ª–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

```
api/
‚îú‚îÄ‚îÄ app.py                    # –û—Å–Ω–æ–≤–Ω–æ–π FastAPI —Å–µ—Ä–≤–µ—Ä (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω)
‚îú‚îÄ‚îÄ opencv_worker.py          # OpenCV –∏–∑–æ–ª—è—Ç–æ—Ä (—É—Å–∫–æ—Ä–µ–Ω)
‚îî‚îÄ‚îÄ ultra_fast_endpoints.py   # –£–ª—å—Ç—Ä–∞-–±—ã—Å—Ç—Ä—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã

static/
‚îî‚îÄ‚îÄ index.html               # –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥
```

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –î–ª—è live –ø–æ—Ç–æ–∫–∞ –∫–∞–º–µ—Ä—ã:
```
GET /api/video_feed?mode=server
WebSocket: /ws/count
```

### –î–ª—è —Ñ–∞–π–ª–æ–≤–æ–≥–æ –ø–æ—Ç–æ–∫–∞ (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π):
```
POST /api/video_file/open
GET /api/video_file/play?id=file1&rate=1.0
WebSocket: /ws/count?id=file1
```

### –î–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:
```
POST /api/video_file/open_ultra_fast
GET /api/video_file/stream_ultra_fast?id=ultra_fast_session
WebSocket: /ws/video_ultra_fast
```

## Backup —Ñ–∞–π–ª—ã

Backup —Ñ–∞–π–ª—ã (index_backup.html, index_video_backup.html) –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —É–¥–∞–ª–µ–Ω—ã –≤—Ä—É—á–Ω—É—é –∏–∑ –ø–∞–ø–∫–∏ static/ –µ—Å–ª–∏ –æ–Ω–∏ –º–µ—à–∞—é—Ç.

---
**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –°–∏—Å—Ç–µ–º–∞ —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ 3-5 —Ä–∞–∑ –±—ã—Å—Ç—Ä–µ–µ —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –∑–∞–¥–µ—Ä–∂–∫–∞–º–∏ –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∫–∞–∫ live –∫–∞–º–µ—Ä—É, —Ç–∞–∫ –∏ —Ñ–∞–π–ª–æ–≤—ã–µ –ø–æ—Ç–æ–∫–∏ –±–µ–∑ —Ñ—Ä–∏–∑–æ–≤.
